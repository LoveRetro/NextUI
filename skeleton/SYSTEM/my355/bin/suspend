#!/bin/sh
set -euo pipefail
exec 0<&-

log() {
    >&2 echo "$1"

    # DEBUGGING
    # echo "$1" >> /mnt/SDCARD/debug.log
}

fix_sleep_sound_bug() {
    # turn it off and on againt
    val=$(amixer cget numid=2 | awk -F'values=' '/: values/{print $2}')
    # This equals amixer sset 'Playback Path' 'OFF' 
    amixer cset numid=2 0
    # This equals amixer sset 'Playback Path' 'HP'/'SPK'
    amixer cset numid=2 $val
}

before() {
    log "Preparing for suspend..."

    # Probably not necessary and dangerous actually
    # log "Turning off input"
    # echo 0 > /sys/module/gpio_keys_polled/parameters/button_enable

    # TODO bluetooth
    # TODO wifi

    touch /tmp/system_suspend
}

after() {
    # log "Turning on input"
    # echo 1 > /sys/module/gpio_keys_polled/parameters/button_enable

    log "Restoring brightness"
    # TODO save and restore backlight settings
    echo 100 > /sys/class/leds/work/brightness

    log "Restoring sound"

    # TODO bluetooth
    # TODO wifi

    rm /tmp/system_suspend
    # fix_sleep_sound_bug

    log "Resumed from suspend."
}

before

log "Suspending..."
sync
echo deep > /sys/power/mem_sleep
echo mem > /sys/power/state
log "Resuming..."

# Resume services in background to reduce UI latency
after &
