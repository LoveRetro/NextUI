#!/bin/sh
set -euo pipefail
exec 0<&-

#logfile="/mnt/SDCARD/.userdata/tg5040/logs/suspend_$(date +%Y%m%d_%H%M%S).log"
#exec >> "$logfile" 2>&1

wifid_running=
bluetoothd_running=

asound_state_dir=/tmp/asound-suspend

before() {
	>&2 echo "Preparing for suspend..."

	>&2 echo "Saving mixer state..."
	mkdir -p "$asound_state_dir"
	alsactl --file "$asound_state_dir/asound.state.pre" store || true

	# Enable charging during suspend by configuring power supply wakeup
	# This ensures the device can charge while in deep sleep
	if [ -f /sys/class/power_supply/axp2202-usb/wakeup ]; then
		>&2 echo "Enabling USB charger wakeup..."
		echo enabled > /sys/class/power_supply/axp2202-usb/wakeup || true
	fi
	if [ -f /sys/class/power_supply/axp2202-battery/wakeup ]; then
		>&2 echo "Enabling battery wakeup..."
		echo enabled > /sys/class/power_supply/axp2202-battery/wakeup || true
	fi
	
	# Enable wake on charger connection/disconnection
	# This allows the device to wake when charger is connected during suspend
	if [ -f /sys/power/wake_lock ]; then
		>&2 echo "Acquiring charger wake lock..."
		echo charger > /sys/power/wake_lock || true
	fi

	if pgrep bluetoothd; then
		bluetoothd_running=1
		>&2 echo "Stopping bluetoothd..."
		/etc/bluetooth/bt_init.sh stop || true
	fi

	if pgrep wpa_supplicant; then
		wifid_running=1
		>&2 echo "Stopping wifi_daemon..."
		killall -15 wifi_daemon || true
		/etc/wifi/wifi_init.sh stop || true
	fi
}

after() {
	>&2 echo "Resumed from suspend."

	# Release charger wake lock after resume
	if [ -f /sys/power/wake_lock ]; then
		>&2 echo "Releasing charger wake lock..."
		echo charger > /sys/power/wake_unlock || true
	fi

	if [ -n "$wifid_running" ]; then
		>&2 echo "Starting wpa_supplicant..."
		/etc/wifi/wifi_init.sh start || true
	fi

	if [ -n "$bluetoothd_running" ]; then
		>&2 echo "Starting bluetoothd..."
		/etc/bluetooth/bt_init.sh start || true
	fi

	# >&2 echo "Restoring mixer state..."
	# alsactl --file "$asound_state_dir/asound.state.post" store || true
	# alsactl --file "$asound_state_dir/asound.state.pre" restore || true
}

before

>&2 echo "Suspending..."
# Use mem_sleep to ensure charging works during suspend
# Some kernels require specific sleep mode for charging support
if [ -f /sys/power/mem_sleep ]; then
	# Try to use s2idle or deep sleep mode that supports charging
	if grep -q "\[s2idle\]" /sys/power/mem_sleep 2>/dev/null; then
		>&2 echo "Using s2idle sleep mode for charging support..."
		echo s2idle > /sys/power/mem_sleep || true
	elif grep -q "\[deep\]" /sys/power/mem_sleep 2>/dev/null; then
		>&2 echo "Using deep sleep mode..."
		echo deep > /sys/power/mem_sleep || true
	fi
fi

# Suspend to RAM - charging should work if wakeup is properly configured
echo mem >/sys/power/state

# Resume services in background to reduce UI latency
after &
